name: "VHS Tape"

on:
  workflow_dispatch:
    inputs: &inputs
      publish:
        description: Publish Tapes
        type: boolean
        default: false
      #continue-on-error:
      #  description: Continue on Error
      #  type: boolean
      #  default: true
  workflow_call:
    inputs: *inputs

env:
  tape-dir: assets
  image-dir: dist
  bucket: cssnr
  bucket-path: bup

jobs:
  vhs:
    name: "VHS ${{ matrix.tape }}"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    #continue-on-error: ${{ inputs.continue-on-error }}
    strategy:
      fail-fast: false
      matrix:
        tape: [demo, banner]

    permissions:
      contents: read

    steps:
      - name: "Checkout"
        uses: actions/checkout@v6

      - name: "Debug event.json"
        continue-on-error: true
        run: cat "${GITHUB_EVENT_PATH}"
      - name: "Debug CTX github"
        continue-on-error: true
        env:
          GITHUB_CTX: ${{ toJSON(github) }}
        run: echo "$GITHUB_CTX"
      - name: "Debug Environment"
        continue-on-error: true
        run: env

      - name: "Set Inputs"
        run: |
          echo github.repository: ${{ github.repository }}
          echo github.ref_name: ${{ github.ref_name  }}
          echo github.event_name: ${{ github.event_name }}

          echo matrix.tape: ${{ matrix.tape }}

          echo env.tape-dir: ${{ env.tape-dir }}
          echo env.image-dir: ${{ env.image-dir }}
          echo env.bucket: ${{ env.bucket }}
          echo env.bucket-path: ${{ env.bucket-path }}

          echo inputs.publish: ${{ inputs.publish }}

          echo "tape=${{ env.tape-dir }}/${{ matrix.tape }}.tape" >> "$GITHUB_ENV"
          echo "home=${HOME}" >> "$GITHUB_ENV"

      - name: "Install Release"
        if: ${{ github.event_name == 'workflow_call' }}
        uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
        with:
          repo: ${{ github.repository }}

      - name: "Install App Dependencies"
        run: sudo apt-get update && sudo apt-get install -y libx11-dev xvfb

      - name: "Setup Go"
        if: ${{ github.event_name != 'workflow_call' }}
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: "Go Build"
        if: ${{ github.event_name != 'workflow_call' }}
        run: |
          go build
          stat bup
          mkdir -p "${{ runner.temp }}/bin"
          mv bup "${{ runner.temp }}/bin"
          file "${{ runner.temp }}/bin/bup"
          echo "${{ runner.temp }}/bin" >> "$GITHUB_PATH"

      - name: "Write Config"
        uses: teunmooij/yaml@cffa9c57cc8d70f64b649ec07cab7e4c49d14ba1 # v1.0.1
        with:
          to-file: "bup.yaml"
          data: |
            {"destination": "${{ env.home }}/backup"}

      - name: "Validate Install"
        #if: ${{ !inputs.publish }}
        run: |
          mkdir -p "${HOME}/backup"
          echo "::group::PATH"
          echo "$PATH"
          echo "::endgroup::"
          which bup
          bup --version
          bup --info
          echo "::group::${{ env.tape }}"
          cat -n ${{ env.tape }}
          echo "::endgroup::"

      - name: "Install VHS"
        uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
        with:
          repo: charmbracelet/vhs
          binaries-location: vhs_0.10.0_Linux_x86_64

      - name: "Install Dependencies"
        id: install
        run: |
          echo "::group::install"
          sudo apt update
          sudo apt install -y ffmpeg ttyd
          echo "::endgroup::"

          ffmpeg -version
          ttyd --version
          vhs --version

      - name: "Create VHS"
        env:
          CI: ""
          TERM: xterm-256color
          COLORTERM: truecolor
        run: |
          xvfb-run --auto-servernum \
          vhs "${{ env.tape }}"

      #- name: "Create APNG"
      #  run: |
      #    ffmpeg -i "${{ env.image-dir }}/*.gif output.png

      - name: "Debug VHS"
        run: |
          ls -lAhR "${{ env.image-dir }}"

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.tape }}
          path: ${{ env.image-dir }}

      - name: "Setup AWS"
        if: ${{ inputs.publish }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_S3_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_S3_SECRET }}
          aws-region: us-east-1

      - name: "AWS S3 Upload"
        if: ${{ inputs.publish }}
        id: upload
        run: |
          for image in "${{ env.image-dir }}"/*; do
            echo "Checking: $image"
            [ ! -f "$image" ] && continue
            if [[ "$image" == *.apng ]]; then
              new_image="${image%.apng}.png"
              echo "Renaming: $image -> $new_image"
              mv "$image" "$new_image"
              image="$new_image"
            fi
            filename="$(basename "$image")"

            destination="${{ env.bucket-path }}/${filename}"
            echo "Uploading: $image -> $destination"
            aws s3 cp "$image" "s3://${{ env.bucket }}/$destination"
            url="https://${{ env.bucket }}.s3.amazonaws.com/$destination"
            echo "url: $url"
            echo "$url" >> "${{ runner.temp }}/results.txt"
          done

      - name: "Debug URLs"
        if: ${{ inputs.publish }}
        continue-on-error: true
        run: |
          cat -n "${{ runner.temp }}/results.txt"

      - name: "Job Summary"
        if: ${{ inputs.publish }}
        continue-on-error: true
        run: |
          md="## ðŸ“¼ VHS ${{ matrix.tape }}\n\n"
          while IFS= read -r url; do
            filename="$(basename "${url}")"
            echo "Processing: $filename - $url"
            md+="### ${filename}\n\n"
            md+="<${url}>\n\n"
            md+="\`\`\`text\n${url}\n\`\`\`\n\n"
            md+="[![URL](${url})](${url})\n\n"
            md+="---\n\n"
          done < "${{ runner.temp }}/results.txt"
          echo -e "${md}" >> "$GITHUB_STEP_SUMMARY"

      #- name: "Web Request"
      #  if: ${{ inputs.publish }}
      #  continue-on-error: true
      #  uses: cssnr/web-request-action@v2
      #  with:
      #    url: ${{ secrets.DISCORD_WEBHOOK }}
      #    data: |
      #      content: "${{ steps.upload.outputs.url }}"
